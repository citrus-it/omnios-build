From eb7ca9504a1b9ba7ed50140fc5b81e1e5e9adf59 Mon Sep 17 00:00:00 2001
From: Viktor Dukhovni <openssl-users@dukhovni.org>
Date: Thu, 11 Sep 2025 18:10:12 +0200
Subject: [PATCH] kek_unwrap_key(): Fix incorrect check of unwrapped key size

Fixes CVE-2025-9230

The check is off by 8 bytes so it is possible to overread by
up to 8 bytes and overwrite up to 4 bytes.
diff -wpruN --no-dereference '--exclude=*.orig' a~/crypto/cms/cms_pwri.c a/crypto/cms/cms_pwri.c
--- a~/crypto/cms/cms_pwri.c	1970-01-01 00:00:00
+++ a/crypto/cms/cms_pwri.c	1970-01-01 00:00:00
@@ -257,7 +257,7 @@ static int kek_unwrap_key(unsigned char
         /* Check byte failure */
         goto err;
     }
-    if (inlen < (size_t)(tmp[0] - 4)) {
+    if (inlen < 4 + (size_t)tmp[0]) {
         /* Invalid length value */
         goto err;
     }
